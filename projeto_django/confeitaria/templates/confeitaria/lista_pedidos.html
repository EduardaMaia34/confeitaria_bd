<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Pedidos</title>
    {% load static %}
    <!-- Adicionando SweetAlert2 para confirmações bonitas -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Georgia', serif;
            background-color: #fff8e6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .navbar {
            width: calc(100%);
            max-width: 1300px;
            margin: 20px 10px 0 10px;
            background-color: #fcb1b0;
            padding: 4px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .navbar-logo {
            height: 50px;
            border-radius: 12px;
        }
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        .navbar-menu a {
            text-decoration: none;
            color: #710100;
            font-size: 18px;
            padding: 6px 12px;
            border-radius: 12px;
            transition: background-color 0.3s ease;
        }
        .navbar-menu a:hover {
            background-color: #ffdeeb;
        }
        .navbar-menu .ativo {
            background-color: #fffbe6;
            font-weight: bold;
        }
        .main-container {
            background-color: #fffaf0;
            border-radius: 20px;
            box-shadow: 0 0 5px #fcb1b0;
            border-top: 1px solid #ffd7c9;
            border-right: 4px solid #ffd7c9;
            border-bottom: 4px solid #ffd7c9;
            border-left: 1px solid #ffd7c9;
            padding: 30px 40px;
            margin: 30px 10px 40px 10px;
            width: calc(100% - 20px);
            max-width: 1200px;
            box-sizing: border-box;
        }
        .container-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            color: #600000;
        }
        .container-header h2 {
            margin: 0;
            font-size: 28px;
            color: #600000;
        }
        .container-header p {
            margin: 5px 0 0 0;
            font-size: 14px;
            color: #8b0000;
        }
        .btn-novo {
            background-color: #600000;
            color: #fff8e6;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .btn-novo:hover {
            background-color: #8b0000;
        }
        .pedidos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            grid-auto-flow: dense;
            padding-top: 20px;
        }
        .pedido-card {
            background-color: #fffaf0;
            border: 2px solid #fbbfc5;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 2px 6px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease-in-out;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .pedido-card:hover {
            transform: translateY(-5px);
        }
        .pedido-card h3 {
            margin: 0 0 10px 0;
            color: #600000;
        }
        .pedido-card .pedido-meta {
            font-size: 14px;
            color: #8b0000;
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ffd7c9;
        }
        .pedido-card ul {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
        }
        .pedido-card ul li {
            margin-bottom: 5px;
            color: #710100;
            font-size: 16px;
        }
        .status-area {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .status-btn-em-preparo {
            color: #600000;
            background-color: #fbbfc5;
            padding: 9px 16px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .status-btn-em-preparo:hover {
            background-color: #ffe6f2;
        }
        .status-btn-pagamento {
            color: #fff8e6;
            background-color: #710100;
            padding: 9px 16px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .status-btn-pagamento:hover {
            background-color: #500000;
        }
        .status-concluido {
            background-color: #600000;
            color: #fff8e6;
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: bold;
        }
        .status-btn-cancelar {
            background-color: #842020;
            color: #ffffe3;
            padding: 9px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .status-btn-cancelar:hover {
            background-color: #ffcdd2;
            color: #600000;
        }
        .menu-icon {
            display: none;
            font-size: 24px;
            cursor: pointer;
            color: #710100;
        }
        .modalidade-retirada {
            background-color: #f5d2d6;
            color: #600000; ;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
        }
        .modalidade-loja {
            background-color: #f3ebda;
            color: #600000;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
        }
        .pedido-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ffd7c9;
            font-size: 16px;
            color: #600000;
            font-weight: bold;
        }
        .observacoes {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #fff5f5;
            border-left: 3px solid #fcb1b0;
            border-radius: 0 8px 8px 0;
            color: #710100;
            font-size: 14px;
            line-height: 1.4;
        }
        @media (max-width: 768px) {
            .navbar-menu {
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
                display: none;
                position: absolute;
                top: 70px;
                right: 10px;
                background-color: #fcb1b0;
                border-radius: 10px;
                padding: 10px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .navbar-menu.show {
                display: flex;
            }
            .menu-icon {
                display: block;
            }
            .navbar {
                flex-wrap: wrap;
                justify-content: space-between;
                padding: 4px 20px;
            }
            .main-container {
                padding: 20px;
            }
            .status-area {
                justify-content: center;
            }
        }
        @media (max-width: 550px) {
            .pedidos-grid {
                grid-template-columns: 1fr;
            }
            .container-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .btn-novo {
                width: 100%;
                margin-top: 15px;
                text-align: center;
            }
        }

        /* Estilos do Modal de Edição */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: #fffaf0;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            position: relative;
            max-width: 700px;
            width: 100%;
            box-sizing: border-box;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-button {
            color: #aaa;
            font-size: 35px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #710100;
            text-decoration: none;
        }

        /* Estilos dos campos de formulário e botões dentro do modal */
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #710100;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ffd7c9;
            border-radius: 10px;
            font-size: 16px;
            background-color: #fffdf8;
            box-sizing: border-box;
            resize: none;
            color: #710100;
        }
        
        .linha-simples {
            margin-bottom: 20px;
        }

        .linha-dupla {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .linha-dupla > div {
            flex: 1;
            min-width: 200px;
            margin-bottom: 20px;
        }

        .helptext {
            font-size: 0.85em;
            color: #8b0000;
            margin-top: 5px;
            display: block;
        }

        .errorlist {
            color: #e74c3c;
            list-style-type: none;
            padding: 0;
            margin-top: 5px;
        }

        .botoes-form {
            text-align: center;
            margin-top: 30px;
        }

        .botao-salvar, .botao-cancelar {
            border: none;
            padding: 12px 25px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 0 10px;
        }

        .botao-salvar {
            background-color: #6e0707;
            color: #fffdf8;
        }

        .botao-salvar:hover {
            background-color: #9a2a2a;
        }

        .botao-cancelar {
            background-color: #fbbfc5;
            color: #600000;
        }

        .botao-cancelar:hover {
            background-color: #ffdde6;
        }

        /* Estilos para itens do pedido no modal */
        .itens-pedido {
            margin: 20px 0;
        }

        .item-pedido {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff5f5;
            border-radius: 8px;
        }

        .item-pedido select {
            flex: 2;
        }

        .item-pedido input[type="number"] {
            flex: 1;
            max-width: 80px;
        }

        .btn-remover-item {
            background-color: #842020;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
        }

        .btn-adicionar-item {
            background-color: #6e0707;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 10px;
        }

    /* Personalização do SweetAlert2 */
.swal2-popup {
    background-color: #fffaf0 !important;
    border-radius: 20px !important;
    border: 2px solid #fbbfc5 !important;
}

.swal2-title {
    color: #710100 !important;
    font-family: 'Georgia', serif !important;
}

.swal2-content {
    color: #8b0000 !important;
    font-family: 'Georgia', serif !important;
}

.swal2-confirm {
    background-color: #600000 !important;
    font-weight: bold !important;
}

.swal2-cancel {
    background-color: #fcb1b0 !important;
    color: #710100 !important;
    font-weight: bold !important;
}

.status-btn-editar {
            background-color: #fbbfc5;
            color: #8b0000; /* cor do texto vermelho escuro */
            padding: 9px 25px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease, color 0.3s ease;
            }
.status-btn-editar:hover {
            background-color: #ffe6f2; /* cor de fundo mais clara no hover */
            color: #600000; /* cor do texto um pouco mais escura no hover */}

.modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 800px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
    </style>
</head>
<body>
    <div class="navbar">
        <img src="{% static 'confeitaria/imagens/LogoBarra.png' %}" alt="Logo Petit Rose" class="navbar-logo">
        <div class="navbar-menu">
            <a href="{% url 'redirecionar_menu' %}">Início</a>
            <a href="{% url 'listar_produto' %}">Produtos</a>
            <a href="{% url 'listar_pedidos' %}" class="ativo">Pedidos</a>
            <a href="{% url 'listar_cliente' %}">Clientes</a>
            <a href="{% url 'relatorio_vendas' %}">Relatórios</a>
            <a href="{% url 'autenticar_login' %}" onclick="confirmarSaida(event)">Sair</a>
            <span class="menu-icon" onclick="toggleMenu()">☰</span>
        </div>
    </div>
    <div class="main-container">
        <div class="container-header">
            <div>
                <h2>Pedidos</h2>
                <p>Visualize e atualize o status dos pedidos dos clientes.</p>
            </div>
            <a href="{% url 'criar_pedido' %}" class="btn-novo">+ Novo Pedido</a>
        </div>
        <div class="pedidos-grid">
            {% for pedido in pedidos %}
            <div class="pedido-card" data-pedido-id="{{ pedido.id }}">
                <div>
                    <div class="pedido-meta">
                        <p>Pedido #{{ pedido.id }}</p>
                        <p>{{ pedido.data_pedido|date:"d/m/Y H:i" }}</p>
                    </div>
                    <p><strong>Cliente:</strong> {{ pedido.cliente.nome|default:"Não informado" }}</p>
                    {% if pedido.modalidade == "retirada" %}
                        <p class="modalidade-retirada">
                            Retirada em: {{ pedido.data_retirada|date:"d/m/Y" }}
                        </p>
                    {% elif pedido.modalidade == "loja" or pedido.modalidade == "Consumo na Loja" or pedido.modalidade == "consumo_loja" %}
                        <p class="modalidade-loja">
                            Consumo na loja
                        </p>
                    {% endif %}
                    <ul>
                        {% for item in pedido.itens_do_pedido.all %}
                            <li>{{ item.quantidade }}x {{ item.id_produto.nome }}</li>
                        {% empty %}
                            <li>Nenhum produto neste pedido</li>
                        {% endfor %}
                    </ul>
                    <div class="pedido-total">
                        <strong>Total:</strong> R$ {{ pedido.valor_total|floatformat:2 }}
                    </div>
                    {% if pedido.observacoes %}
                        <p class="observacoes">
                            <strong>Obs:</strong> {{ pedido.observacoes }}
                        </p>
                    {% endif %}
                </div>
                <div class="status-area" id="status-area-{{ pedido.id }}">
                    {% if pedido.em_preparo and not pedido.pago %}
                        <button class="status-btn-em-preparo" onclick="marcarComoPronto('{{ pedido.id }}')">Em preparo</button>
                    {% elif not pedido.em_preparo and not pedido.pago %}
                        <button class="status-btn-pagamento" onclick="confirmarPagamento('{{ pedido.id }}')">
                            Confirmar Pagamento
                        </button>
                    {% else %}
                        <span class="status-concluido">Concluído</span>
                    {% endif %}
                    <button class="status-btn-editar" onclick="abrirModalEdicao({{ pedido.id }})">
                        Editar Pedido
                    </button>
                    <button class="status-btn-cancelar" onclick="cancelarPedido('{{ pedido.id }}')">
                        Cancelar Pedido
                    </button>
                    
                </div>
            </div>
            {% empty %}
            <p>Nenhum pedido encontrado.</p>
            {% endfor %}
        </div>
    </div>

    <div id="editPedidoModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Editar Pedido</h2>
            <form id="edit-pedido-form" method="POST">
                {% csrf_token %}
                <input type="hidden" name="pedido_id" id="pedido-id">
                <input type="hidden" name="total_geral" id="edit-total">

                <div class="linha-dupla">
                    <div class="form-group">
                        <label for="edit-nome-cliente">Nome do Cliente:</label>
                        <input type="text" id="edit-nome-cliente" name="nome_cliente" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-telefone">Telefone:</label>
                        <input type="text" id="edit-telefone" name="telefone">
                    </div>
                </div>

                <div class="linha-dupla">
                    <div class="form-group">
                        <label for="edit-email">Email:</label>
                        <input type="text" id="edit-email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="edit-modalidade">Modalidade:</label>
                        <select id="edit-modalidade" name="modalidade">
                            <option value="retirada">Retirada</option>
                            <option value="loja">Consumo na Loja</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Itens do Pedido:</label>
                    <div id="detalhes-pedido-itens">
                        </div>
                    <button type="button" class="btn-adicionar-item" id="add-item-btn">
                        + Adicionar Item
                    </button>
                </div>

                <div id="total-modal" class="pedido-total">Total: R$ 0,00</div>

                <div class="form-group">
                    <label for="edit-observacoes">Observações:</label>
                    <textarea id="edit-observacoes" name="observacoes" rows="3"></textarea>
                </div>
                <div class="botoes-form">
                    <button type="submit" class="botao-salvar">Salvar Alterações</button>
                    <button type="button" class="botao-cancelar" onclick="modal.style.display='none'">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    {{ produtos|json_script:"produtos_json_data" }}

 <script>
    // 1. Obter os dados dos produtos de forma segura
    const produtosScript = document.getElementById('produtos_json_data');
    let produtos = [];
    try {
        if (produtosScript && produtosScript.textContent) {
            produtos = JSON.parse(produtosScript.textContent);
        }
    } catch (e) {
        console.error("Erro ao fazer parse do JSON de produtos:", e);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Erro ao carregar os dados dos produtos. Por favor, recarregue a página.',
        });
    }

    // Obter o token CSRF
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // 2. Elementos do modal de edição
    const modal = document.getElementById('editPedidoModal');
    const form = document.getElementById('edit-pedido-form');
    const detalhesPedidoDiv = document.getElementById('detalhes-pedido-itens');
    const totalElement = document.getElementById('edit-total');
    const totalModalElement = document.getElementById('total-modal');
    const addBtn = document.getElementById('add-item-btn');

    // Funções para o modal de edição
    function abrirModalEdicao(pedidoId) {
        console.log("Abrindo modal para o pedido ID:", pedidoId);
        
        // Limpa os itens do pedido do modal e campos de cliente antes de carregar os novos
        detalhesPedidoDiv.innerHTML = '';
        document.getElementById('edit-nome-cliente').value = '';
        document.getElementById('edit-telefone').value = '';
        document.getElementById('edit-email').value = '';
        document.getElementById('edit-observacoes').value = '';
        document.getElementById('edit-modalidade').value = 'retirada'; // Valor padrão

        fetch(`/api/pedidos/${pedidoId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log("Dados do pedido recebidos:", data);
                
                // Popula os campos do formulário com os dados do pedido
                document.getElementById('pedido-id').value = data.pedido.id;
                document.getElementById('edit-nome-cliente').value = data.cliente.nome || '';
                document.getElementById('edit-telefone').value = data.cliente.telefone || '';
                document.getElementById('edit-email').value = data.cliente.email || '';
                document.getElementById('edit-modalidade').value = data.pedido.modalidade;
                document.getElementById('edit-observacoes').value = data.pedido.observacoes || '';

                // Popula os itens do pedido
                if (data.itens && Array.isArray(data.itens)) {
                    data.itens.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'item-pedido';
                        itemDiv.innerHTML = `
                            <input type="hidden" name="itens[${item.id}][id]" value="${item.id}">
                            <select name="itens[${item.id}][id_produto]">
                                ${produtos.map(p => 
                                    `<option value="${p.id}" ${p.id === item.produto_id ? 'selected' : ''}>${p.nome}</option>`
                                ).join('')}
                            </select>
                            <input type="number" name="itens[${item.id}][quantidade]" value="${item.quantidade}" min="1" required>
                            <button type="button" class="btn-remover-item" onclick="removerItem(this, ${item.id})">Remover</button>
                        `;
                        detalhesPedidoDiv.appendChild(itemDiv);
                    });
                } else {
                    console.warn('A resposta da API não contém uma lista de itens válida.');
                }

                atualizarTotalModal();
                modal.style.display = 'flex';
            })
            .catch(error => {
                console.error('Erro ao carregar detalhes do pedido:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro!',
                    text: 'Não foi possível carregar os detalhes do pedido. Por favor, tente novamente.',
                });
            });
    }

    // Adiciona um novo item vazio ao modal
    function adicionarItem() {
        console.log("Adicionando novo item.");
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item-pedido';
        
        const novoItemId = `novo-${Date.now()}`;

        itemDiv.innerHTML = `
            <select name="itens[${novoItemId}][id_produto]">
                ${produtos.map(p => 
                    `<option value="${p.id}">${p.nome}</option>`
                ).join('')}
            </select>
            <input type="number" name="itens[${novoItemId}][quantidade]" value="1" min="1" required>
            <button type="button" class="btn-remover-item" onclick="removerItem(this)">Remover</button>
        `;
        detalhesPedidoDiv.appendChild(itemDiv);
        
        atualizarTotalModal();
    }

    function atualizarTotalModal() {
        let total = 0;
        const itens = detalhesPedidoDiv.querySelectorAll('.item-pedido');
        itens.forEach(itemDiv => {
            const produtoId = itemDiv.querySelector('select').value;
            const quantidadeInput = itemDiv.querySelector('input[type="number"]');
            const quantidade = quantidadeInput ? parseInt(quantidadeInput.value) : 0;
            const produto = produtos.find(p => p.id == produtoId);
            if (produto) {
                total += quantidade * produto.preco;
            }
        });

        totalModalElement.textContent = `Total: R$ ${total.toFixed(2)}`;
        document.getElementById('edit-total').value = total.toFixed(2);
    }

    // Remove um item do modal
    function removerItem(button, itemId) {
        if (itemId) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `itens_removidos[]`;
            input.value = itemId;
            form.appendChild(input);
        }
        button.closest('.item-pedido').remove();
        atualizarTotalModal();
    }
        
    // 3. Lógica de envio do formulário
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        const pedidoId = document.getElementById('pedido-id').value;
        const formData = new FormData(form);
        const data = {
            nome_cliente: formData.get('nome_cliente'),
            telefone: formData.get('telefone'),
            email: formData.get('email'),
            modalidade: formData.get('modalidade'),
            observacoes: formData.get('observacoes'),
            valor_total: formData.get('total_geral'),
            itens_pedido: [],
            itens_removidos: []
        };
        
        const itens = detalhesPedidoDiv.querySelectorAll('.item-pedido');
        itens.forEach(itemDiv => {
            const select = itemDiv.querySelector('select');
            const quantidade = itemDiv.querySelector('input[type="number"]');
            const itemIdInput = itemDiv.querySelector('input[name*="[id]"]');

            data.itens_pedido.push({
                id: itemIdInput ? itemIdInput.value : null,
                id_produto: select.value,
                quantidade: quantidade.value
            });
        });

        const itensRemovidosInputs = form.querySelectorAll('input[name="itens_removidos[]"]');
        itensRemovidosInputs.forEach(input => {
            data.itens_removidos.push(input.value);
        });

        console.log("Dados a serem enviados:", data);
        
        fetch(`/api/pedidos/${pedidoId}/update_pedido/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(result => {
            console.log("Sucesso:", result);
            Swal.fire('Sucesso!', 'Pedido atualizado com sucesso.', 'success')
                .then(() => {
                    location.reload();
                });
        })
        .catch(error => {
            console.error('Erro ao atualizar pedido:', error);
            let errorMessage = 'Não foi possível atualizar o pedido. Tente novamente.';
            if (error.non_field_errors) {
                errorMessage = error.non_field_errors[0];
            } else if (error.itens_pedido) {
                errorMessage = 'Erro nos itens do pedido: ' + JSON.stringify(error.itens_pedido);
            }
            Swal.fire('Erro!', errorMessage, 'error');
        });
    });

    // 4. Funções auxiliares e de navegação (sem alterações)
    detalhesPedidoDiv.addEventListener('change', atualizarTotalModal);

    async function confirmarPagamento(pedidoId) { ... }
    async function cancelarPedido(pedidoId) { ... }
    function toggleMenu() { ... }
    function confirmarSaida(event) { ... }
    window.onclick = function(event) { ... }

    document.addEventListener('DOMContentLoaded', (event) => {
        const closeModalBtn = document.querySelector('.close-button');
        if (closeModalBtn) {
            closeModalBtn.onclick = function() {
                modal.style.display = "none";
            };
        }
        addBtn.addEventListener('click', adicionarItem);
    });

</script>
</body>
</html>