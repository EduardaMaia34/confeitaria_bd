{# confeitaria/templates/editar_pedido.html #}
<!DOCTYPE html>
<html>
<head>
    <title>Editar Pedido</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2, h3 { color: #333; }
        form p { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; font-weight: bold; }
        input[type="text"], input[type="number"], select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        a { color: purple; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .errorlist { color: red; list-style-type: none; padding-left: 0; margin-top: 5px; }
        
        /* Section for adding new products */
        .add-new-product-section {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .add-new-product-section .form-fields {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .add-new-product-section .form-fields p {
            margin: 0; /* Remove default paragraph margin */
        }
        .add-new-product-section .form-fields label {
            width: auto; /* Let label width adjust */
            font-weight: normal;
        }
        .add-new-product-button {
            background-color: #28a745; /* Green for add */
        }
        .add-new-product-button:hover {
            background-color: #218838;
        }

        /* Section for existing items */
        .existing-items-section {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr; /* Product Name, Quantity, Apagar Button */
            gap: 10px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .item-row.header {
            font-weight: bold;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .item-row:last-of-type {
            border-bottom: none;
        }
        .remove-item-button {
            background-color: #dc3545; /* Red for remove */
            padding: 5px 10px; /* Smaller padding for individual buttons */
        }
        .remove-item-button:hover {
            background-color: #c82333;
        }

    </style>
</head>
<body>
    <h1>Editar Pedido</h1>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <h2>Cliente: {{ pedido.cliente.nome }}</h2>

    {# Form for adding new products #}
    <div class="add-new-product-section">
        <h3>Adicionar Produto</h3>
        <form method="post">
            {% csrf_token %}
            <div class="form-fields">
                <p>{{ add_product_form.id_produto.label_tag }} {{ add_product_form.id_produto }}</p>
                <p>{{ add_product_form.quantidade.label_tag }} {{ add_product_form.quantidade }}</p>
                <button type="submit" name="add_new_product" class="add-new-product-button">Adicionar</button>
            </div>
            {% if add_product_form.errors %}
                <ul class="errorlist">
                    {% for field_errors in add_product_form.errors.values %}
                        {% for error in field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            {% endif %}
        </form>
    </div>

    {# Form for managing existing products #}
    <div class="existing-items-section">
        <h3>Itens do Pedido</h3>
        <form method="post">
            {% csrf_token %}

            {{ item_formset.management_form }}

            <h2>Itens do Pedido Existentes</h2>
            {% for form in item_formset %}
                <div class="pedido-produto-item" style="border: 1px solid #ccc; padding: 10px; margin-bottom: 15px;">
                    {# The hidden ID field for the PedidoProduto instance is essential #}
                    {{ form.id }} 

                    {# Display product name, and keep id_produto as a hidden field #}
                    <p>
                        <strong>Produto:</strong> 
                        {% if form.instance.id %} {# Check if it's an existing instance #}
                            {{ form.instance.id_produto.nome }}
                            {{ form.id_produto.as_hidden }} {# Keep the id_produto value in a hidden input #}
                        {% else %}
                            {# This part is for new, empty forms if your formset allows adding, not strictly for 'save_existing_items' #}
                            {{ form.id_produto.label_tag }} {{ form.id_produto }}
                        {% endif %}
                    </p>

                    <p>
                        <strong>Quantidade:</strong> 
                        {{ form.quantidade }} {# This should be your input field #}
                    </p>

                    {# Display field-specific errors right next to the field #}
                    {% if form.id_produto.errors %}
                        <ul class="errorlist">
                            {% for error in form.id_produto.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    {% if form.quantidade.errors %}
                        <ul class="errorlist">
                            {% for error in form.quantidade.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}

                    {# Non-field errors for this specific form in the formset (e.g., from clean() method) #}
                    {% if form.non_field_errors %}
                        <ul class="errorlist">
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    
                    {# If you allow deleting items via the formset, you'd also include: #}
                    {# {{ form.DELETE }} <label for="{{ form.DELETE.id_for_label }}">Remover</label> #}

                    <hr>
                </div>
            {% endfor %}

            {# Display overall formset errors (e.g., if total forms exceeds max_num or min_num not met) #}
            {% if item_formset.non_form_errors %}
                <ul class="errorlist">
                    {% for error in item_formset.non_form_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

    <button type="submit" name="save_existing_items" class="btn btn-primary">Salvar Alterações dos Itens</button>
</form>

    </div>

</body>
</html>

