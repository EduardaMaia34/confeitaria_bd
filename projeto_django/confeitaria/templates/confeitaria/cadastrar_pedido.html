<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Novo Pedido</title>
    {% load static %}
    <style>

        body {
            font-family: 'Georgia', serif;
            background-color: #fff8e6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        /* Ajuste para que a cor de todos os textos seja a mesma */
        body, h1, h2, h3, h4, h5, h6, label {
            color: #600000;
        }

        .navbar {
            width: calc(100%);
            max-width: 1300px;
            margin: 20px 10px 0 10px;
            background-color: #fcb1b0;
            padding: 4px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .navbar-logo {
            height: 50px;
            border-radius: 12px;
        }

        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .navbar-menu a {
            text-decoration: none;
            color: #710100;
            font-size: 18px;
            padding: 6px 12px;
            border-radius: 12px;
            transition: background-color 0.3s ease;
        }

        .navbar-menu a:hover {
            background-color: #ffdeeb;
        }

        .navbar-menu .ativo {
            background-color: #fffbe6;
            font-weight: bold;
        }

        .main-container {
            background-color: #fffaf0;
            border-radius: 20px;
            box-shadow: 0 0 5px #fcb1b0;
            border-top: 1px solid #ffd7c9;
            border-right: 4px solid #ffd7c9;
            border-bottom: 4px solid #ffd7c9;
            border-left: 1px solid #ffd7c9;
            padding: 30px 40px;
            margin: 30px 10px 40px 10px;
            width: calc(100% - 20px);
            max-width: 1200px;
            box-sizing: border-box;
            position: relative; /* Adicionado para posicionar o botão de cancelar */
        }

        .form-content {
            display: grid;
            gap: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            border: 2px solid #fbbfc5;
            background-color: #fffaf0;
            padding: 8px 12px;
            border-radius: 8px;
            color: #710100;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #fcb1b0;
            box-shadow: 0 0 5px #ffdeeb;
        }

        /* Estilo para a caixa de observações */
        #modal-observacoes {
            border: 2px solid #fbbfc5;
            background-color: #fffaf0;
            padding: 8px 12px;
            border-radius: 8px;
            resize: none;
            color: #710100;
        }


        .input-group {
            display: flex;
            align-items: center;
        }

        .input-group button {
            background-color: #600000;
            color: #fff8e6;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }

        .items-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        
        .items-list-item {
            background-color: #fbbfc5;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: #600000;
        }

        .items-list-item .delete-button {
            background: none;
            border: none;
            cursor: pointer;
            color: #600000;
            font-size: 18px;
        }
        
        .total-section {
            text-align: right;
            margin-top: 20px;
            /* Flexbox para alinhar o total e o desconto verticalmente */
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .total-section h4,
        .total-section h5 {
            margin: 0;
            color: #600000;
        }

        .submit-section {
            text-align: right;
            margin-top: 20px;
        }

        .btn-adicionar {
            background-color: #600000;
            color: #fff8e6;
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        .menu-icon {
            display: none;
            font-size: 24px;
            cursor: pointer;
            color: #710100;
        }
        
        .errorlist {
            list-style: none;
            padding: 10px;
            margin: 0 0 20px 0;
            background-color: #ffdeeb;
            color: #8b0000;
            border-radius: 10px;
        }

        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .navbar-menu {
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
                display: none;
                position: absolute;
                top: 70px;
                right: 10px;
                background-color: #fcb1b0;
                border-radius: 10px;
                padding: 10px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .navbar-menu.show {
                display: flex;
            }
            .menu-icon {
                display: block;
            }
            .navbar {
                flex-wrap: wrap;
                justify-content: space-between;
                padding: 4px 20px;
            }
            .main-container {
                padding: 20px;
            }
        }
        
        @media (max-width: 550px) {
            .form-row {
                flex-direction: column;
                align-items: stretch;
            }
            .form-group {
                width: 100%;
            }
        }


        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fffaf0;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-content .close-button {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            color: #8b0000;
            cursor: pointer;
        }

        #modal-observacoes {
            border: 2px solid #fbbfc5;
            background-color: #fffaf0;
            padding: 8px 12px;
            border-radius: 8px;
            resize: none;
            color: #710100;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            
        }
        
        /* Ajuste para que as linhas do modal tenham a cor solicitada */
        .modal-body hr {
            border-top: 1px solid #600000;
        }

        .btn-rosa {
            background-color: #fbbfc5;
            color: #600000;
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-rosa:hover {
            background-color: #ffdde6;
            transform: translateY(-2px);
        }

        .btn-vinho {
            background-color: #600000; 
            color: #fff8e6;
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-vinho:hover {
            background-color: #8b0000;
            transform: translateY(-2px);
        }
        
        /* Estilo para o novo botão de cancelar */
        #btn-cancelar {
            background-color: #fbbfc5;
            color: #600000;
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            position: absolute; /* Posicionamento absoluto dentro do container */
            bottom: 30px; /* Distância da parte inferior */
            left: 40px; /* Distância da parte esquerda */
        }
        
        #btn-cancelar:hover {
            background-color: #ffdde6;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="navbar">
        <img src="{% static 'confeitaria/imagens/LogoBarra.png' %}" alt="Logo Petit Rose" class="navbar-logo">
        <div class="navbar-menu">
            <a href="{% url 'menu' %}">Início</a>
            <a href="{% url 'listar_produto' %}">Produtos</a>
            <a href="{% url 'listar_pedidos' %}" class="ativo">Pedidos</a>
            <a href="{% url 'listar_cliente' %}">Clientes</a>
            <a href="{% url 'relatorio_vendas' %}">Relatórios</a>
            <a href="{% url 'autenticar_login' %}">Sair</a>
            <span class="menu-icon" onclick="toggleMenu()">☰</span>
        </div>
    </div>

    <div class="main-container">
        <h1>Novo Pedido</h1>

        <form id="pedido-form">
            {% csrf_token %}
            
            <div class="form-content">
                <div class="form-row">
                    <div class="form-group" style="flex-grow: 2;">
                        <label for="id_cliente">Nome do Cliente</label>
                        <select id="id_cliente" name="cliente">
                            <option value="">---------</option>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}" data-telefone="{{ cliente.telefone }}">{{ cliente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" id="btn-criar-cliente" class="btn-adicionar hidden" style="align-self: flex-end; white-space: nowrap;">Criar Cadastro</button>
                    
                    <div class="form-group">
                        <label for="id_modalidade">Modalidade</label>
                        <select id="id_modalidade" name="modalidade">
                            <option value="consumo_loja">Consumo na Loja</option>
                            <option value="retirada">Retirada</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="data-retirada-group">
                        <label for="id_data_retirada">Data retirada</label>
                        <input type="date" id="id_data_retirada" name="data_retirada">
                    </div>
                </div>
                
                <h3>Adicionar Produtos</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_produto">Produto</label>
                        <select id="id_produto">
                            {% for produto in produtos %}
                                <option value="{{ produto.id }}" data-preco="{{ produto.preco }}">{{ produto.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" style="width: 100px;">
                        <label for="quantidade">Quantidade</label>
                        <input type="number" id="quantidade" value="1" min="1">
                    </div>
                    <button type="button" class="btn-adicionar" id="add-item-btn">+ Adicionar Item</button>
                </div>
            </div>
            
            <h3>Itens do Pedido</h3>
            <ul class="items-list" id="items-list">
            </ul>

            <div class="total-section">
                <h4 style="font-weight: bold;">Total: R$ <span id="total-price">0,00</span></h4>
                <h5 id="desconto-valor" class="hidden">Desconto: R$ <span id="desconto-price">0,00</span></h5>
            </div>

            <div class="submit-section">
                <button type="button" class="btn-adicionar" id="concluir-pedido-btn">Criar Pedido</button>
            </div>
        </form>
        
        <button type="button" id="btn-cancelar">Cancelar</button>
    </div>

    <div id="finalizar-pedido-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Finalizar Pedido</h2>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>Dados do Cliente:</label>
                    <input type="text" id="modal-cliente-nome" readonly>
                </div>
                <div class="form-group">
                    <label>Telefone:</label>
                    <input type="text" id="modal-cliente-telefone" readonly>
                </div>
                <div class="form-group">
                    <label>Data:</label>
                    <input type="text" id="modal-data" readonly>
                </div>
                
                <hr>
                
                <h3>Resumo do Pedido</h3>
                <ul id="modal-resumo-itens">
                </ul>

                <div class="modal-total">
                    <label>Total:</label>
                    <span id="modal-total-price-modal">R$ 0,00</span>
                </div>
                <div id="modal-desconto-container" class="hidden" style="text-align: right; font-weight: normal;">
                    <span style="font-size: 0.9em; color: #600000;">Desconto: R$ <span id="modal-desconto-price">0,00</span></span>
                </div>

                <hr>

                <div class="form-group">
                    <label for="modal-forma-pagamento">Forma de Pagamento:</label>
                    <select id="modal-forma-pagamento">
                        <option value="pix">PIX</option>
                        <option value="cartao_credito">Cartão de Crédito</option>
                        <option value="cartao_debito">Cartão de Débito</option>
                        <option value="dinheiro">Dinheiro</option> </select>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modal-observacoes">Observações:</label>
                    <textarea id="modal-observacoes" rows="3"></textarea>
                </div>
            </div>

            <div class="modal-buttons">
                <button id="voltar-btn" class="modal-btn btn-rosa">Voltar</button>
                <button id="confirmar-btn" class="modal-btn btn-vinho">Confirmar Pedido</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modalidadeSelect = document.getElementById('id_modalidade');
            const dataRetiradaGroup = document.getElementById('data-retirada-group');
            const clienteSelect = document.getElementById('id_cliente');
            const btnCriarCliente = document.getElementById('btn-criar-cliente');
            
            // Novos elementos do desconto na página principal
            const descontoValor = document.getElementById('desconto-valor');
            const descontoPriceSpan = document.getElementById('desconto-price');
            
            // Novo botão de cancelar
            const btnCancelar = document.getElementById('btn-cancelar');

            function toggleDataRetirada() {
                if (modalidadeSelect.value === 'retirada') {
                    dataRetiradaGroup.classList.remove('hidden');
                } else {
                    dataRetiradaGroup.classList.add('hidden');
                }
            }
            toggleDataRetirada();
            modalidadeSelect.addEventListener('change', toggleDataRetirada);

            function toggleCriarClienteBtn() {
                if (clienteSelect.value === '') {
                    btnCriarCliente.classList.remove('hidden');
                } else {
                    btnCriarCliente.classList.add('hidden');
                }
            }
            toggleCriarClienteBtn();
            clienteSelect.addEventListener('change', toggleCriarClienteBtn);
            
            // Lógica para o botão de criar cliente (redireciona)
            btnCriarCliente.addEventListener('click', function() {
                window.location.href = "{% url 'criar_cliente' %}";
            });
            
            // Lógica para o botão de cancelar
            btnCancelar.addEventListener('click', function() {
                window.location.href = "{% url 'listar_pedidos' %}";
            });
            
            const addItemBtn = document.getElementById('add-item-btn');
            const produtoSelect = document.getElementById('id_produto');
            const quantidadeInput = document.getElementById('quantidade');
            const itemsList = document.getElementById('items-list');
            const totalPriceSpan = document.getElementById('total-price');

            let pedidoItems = [];

            addItemBtn.addEventListener('click', function() {
                const produtoId = produtoSelect.value;
                const produtoNome = produtoSelect.options[produtoSelect.selectedIndex].text;
                const quantidade = parseInt(quantidadeInput.value);
                const precoUnitario = parseFloat(produtoSelect.options[produtoSelect.selectedIndex].dataset.preco);

                if (quantidade > 0 && !isNaN(precoUnitario)) {
                    const existingItem = pedidoItems.find(item => item.id === produtoId);

                    if (existingItem) {
                        existingItem.quantidade += quantidade;
                        existingItem.preco_total = existingItem.quantidade * precoUnitario;
                    } else {
                        const item = {
                            id: produtoId,
                            nome: produtoNome,
                            quantidade: quantidade,
                            preco_total: quantidade * precoUnitario
                        };
                        pedidoItems.push(item);
                    }
                    
                    renderizarItens();
                } else {
                    alert('Selecione um produto e uma quantidade válida.');
                }
            });

            function renderizarItens() {
                itemsList.innerHTML = '';
                let subtotal = 0;
                pedidoItems.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'items-list-item';
                    li.innerHTML = `
                        <span>${item.quantidade}x ${item.nome} - R$ ${(item.preco_total).toFixed(2).replace('.', ',')}</span>
                        <button type="button" class="delete-button" data-index="${index}">
                            &times;
                        </button>
                    `;
                    itemsList.appendChild(li);
                    subtotal += item.preco_total;
                });

                let totalFinal = subtotal;
                const clienteId = clienteSelect.value;
                
                if (clienteId !== "") {
                    // Calcula o total com desconto e o valor do desconto separadamente
                    const desconto = subtotal * 0.1;
                    totalFinal = subtotal - desconto;
                    
                    descontoPriceSpan.textContent = desconto.toFixed(2).replace('.', ',');
                    descontoValor.classList.remove('hidden');
                } else {
                    descontoValor.classList.add('hidden');
                }

                totalPriceSpan.textContent = totalFinal.toFixed(2).replace('.', ',');
            }
            
            itemsList.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-button')) {
                    const index = e.target.dataset.index;
                    pedidoItems.splice(index, 1);
                    renderizarItens();
                }
            });

            clienteSelect.addEventListener('change', renderizarItens);

            const concluirBtn = document.getElementById('concluir-pedido-btn');
            const modal = document.getElementById('finalizar-pedido-modal');
            const fecharBtn = document.querySelector('.close-button');
            const voltarBtn = document.getElementById('voltar-btn');
            const confirmarBtn = document.getElementById('confirmar-btn');
            
            // Novos elementos do desconto no modal
            const modalDescontoContainer = document.getElementById('modal-desconto-container');
            const modalDescontoPrice = document.getElementById('modal-desconto-price');

            const modalClienteNome = document.getElementById('modal-cliente-nome');
            const modalClienteTelefone = document.getElementById('modal-cliente-telefone');
            const modalData = document.getElementById('modal-data');
            const modalResumoItens = document.getElementById('modal-resumo-itens');
            const modalTotalPrice = document.getElementById('modal-total-price-modal');
            const modalFormaPagamento = document.getElementById('modal-forma-pagamento');
            const modalObservacoes = document.getElementById('modal-observacoes');
            

            concluirBtn.addEventListener('click', function(event) {
                event.preventDefault();
                
                if (pedidoItems.length === 0) {
                    alert('Por favor, adicione pelo menos um item ao pedido.');
                    return;
                }

                const clienteId = clienteSelect.value;

                let clienteNome = 'Cliente Sem Cadastro';
                let clienteTelefone = 'N/A';
                if (clienteId !== "") {
                    const selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
                    clienteNome = selectedOption.text;
                    clienteTelefone = selectedOption.dataset.telefone || 'Não informado';
                }

                const dataPedido = new Date().toLocaleDateString('pt-BR');

                modalClienteNome.value = clienteNome;
                modalClienteTelefone.value = clienteTelefone;
                modalData.value = dataPedido;
                
                modalResumoItens.innerHTML = '';
                let subtotal = 0;
                pedidoItems.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.quantidade}x ${item.nome} - R$ ${item.preco_total.toFixed(2).replace('.', ',')}`;
                    modalResumoItens.appendChild(li);
                    subtotal += item.preco_total;
                });
                
                let totalFinal = subtotal;
                if (clienteId !== "") {
                    const desconto = subtotal * 0.1;
                    totalFinal = subtotal - desconto;
                    modalDescontoPrice.textContent = desconto.toFixed(2).replace('.', ',');
                    modalDescontoContainer.classList.remove('hidden');
                } else {
                    modalDescontoContainer.classList.add('hidden');
                }
                
                modalTotalPrice.textContent = `R$ ${totalFinal.toFixed(2).replace('.', ',')}`;
                
                modal.style.display = 'flex';
            });

            fecharBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            voltarBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            confirmarBtn.addEventListener('click', () => {
                const clienteId = clienteSelect.value;
                const modalidade = modalidadeSelect.value;
                const dataRetirada = document.getElementById('id_data_retirada').value;
                const formaPagamento = modalFormaPagamento.value;
                const observacoes = modalObservacoes.value;
                
                const dadosFinais = {
                    'cliente': clienteId,
                    'modalidade': modalidade,
                    'data_retirada': dataRetirada,
                    'forma_pagamento': formaPagamento,
                    'observacoes': observacoes,
                    'pedido_items': pedidoItems
                };
                
                fetch('{% url "criar_pedido" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(dadosFinais)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Pedido finalizado com sucesso!');
                        window.location.href = '{% url "listar_pedidos" %}';
                    } else {
                        alert('Erro ao finalizar o pedido: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Ocorreu um erro ao enviar o pedido.');
                });
            });
        });
    </script>
</body>
</html>